<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=11; IE=10; IE=9; IE=8; IE=7; IE=EDGE" />
        <title>宏定义 | </title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.3.4">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    
    <link rel="prev" href="../xml_eng/xml_eng.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">


        
    <div class="book" data-level="22" data-basepath=".." data-revision="1463048530419">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                         Introduction
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" data-path="cron_service/cron_service.html">
            
                
                    <a href="../cron_service/cron_service.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         cron_service
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2" data-path="cs_api/cs_api.html">
            
                
                    <a href="../cs_api/cs_api.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                         cs_api
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3" data-path="evo/evo.html">
            
                
                    <a href="../evo/evo.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                         evo
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4" data-path="ewp_adapter/ewp_adapter.html">
            
                
                    <a href="../ewp_adapter/ewp_adapter.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                         ewp_adapter
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="5" data-path="ewp_app_manager/ewp_app_manager.html">
            
                
                    <a href="../ewp_app_manager/ewp_app_manager.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                         ewp_app_manager
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="6" data-path="ewp_channel_util/ewp_channel_util.html">
            
                
                    <a href="../ewp_channel_util/ewp_channel_util.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                         ewp_channel_util
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="7" data-path="ewp_conf_util/ewp_conf_util.html">
            
                
                    <a href="../ewp_conf_util/ewp_conf_util.html">
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                         ewp_conf_util
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="8" data-path="ewp_file_util/ewp_file_util.html">
            
                
                    <a href="../ewp_file_util/ewp_file_util.html">
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                         ewp_file_util
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="9" data-path="ewp_http_client/ewp_http_client.html">
            
                
                    <a href="../ewp_http_client/ewp_http_client.html">
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                         ewp_http_client
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="10" data-path="ewp_json/ewp_json.html">
            
                
                    <a href="../ewp_json/ewp_json.html">
                        <i class="fa fa-check"></i>
                        
                            <b>10.</b>
                        
                         ewp_json
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="11" data-path="ewp_params/ewp_params.html">
            
                
                    <a href="../ewp_params/ewp_params.html">
                        <i class="fa fa-check"></i>
                        
                            <b>11.</b>
                        
                         ewp_params
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="12" data-path="ewp_pubsub_service/ewp_pubsub_service.html">
            
                
                    <a href="../ewp_pubsub_service/ewp_pubsub_service.html">
                        <i class="fa fa-check"></i>
                        
                            <b>12.</b>
                        
                         ewp_pubsub_service
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="13" data-path="ewp_render_util/ewp_render_util.html">
            
                
                    <a href="../ewp_render_util/ewp_render_util.html">
                        <i class="fa fa-check"></i>
                        
                            <b>13.</b>
                        
                         ewp_render_util
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="14" data-path="ewp_str_util/ewp_str_util.html">
            
                
                    <a href="../ewp_str_util/ewp_str_util.html">
                        <i class="fa fa-check"></i>
                        
                            <b>14.</b>
                        
                         ewp_str_util
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="15" data-path="ewp_time/ewp_time.html">
            
                
                    <a href="../ewp_time/ewp_time.html">
                        <i class="fa fa-check"></i>
                        
                            <b>15.</b>
                        
                         ewp_time
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="16" data-path="ewp_unicode/ewp_unicode.html">
            
                
                    <a href="../ewp_unicode/ewp_unicode.html">
                        <i class="fa fa-check"></i>
                        
                            <b>16.</b>
                        
                         ewp_unicode
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="17" data-path="ewp_util/ewp_util.html">
            
                
                    <a href="../ewp_util/ewp_util.html">
                        <i class="fa fa-check"></i>
                        
                            <b>17.</b>
                        
                         ewp_util
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="18" data-path="ewp_yaws_util/ewp_yaws_util.html">
            
                
                    <a href="../ewp_yaws_util/ewp_yaws_util.html">
                        <i class="fa fa-check"></i>
                        
                            <b>18.</b>
                        
                         ewp_yaws_util
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="19" data-path="push/push.html">
            
                
                    <a href="../push/push.html">
                        <i class="fa fa-check"></i>
                        
                            <b>19.</b>
                        
                         push
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="20" data-path="session_service/session_service.html">
            
                
                    <a href="../session_service/session_service.html">
                        <i class="fa fa-check"></i>
                        
                            <b>20.</b>
                        
                         session_service
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="21" data-path="xml_eng/xml_eng.html">
            
                
                    <a href="../xml_eng/xml_eng.html">
                        <i class="fa fa-check"></i>
                        
                            <b>21.</b>
                        
                         xml_eng
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="22" data-path="define/define.html">
            
                
                    <a href="../define/define.html">
                        <i class="fa fa-check"></i>
                        
                            <b>22.</b>
                        
                         宏定义
                    </a>
                
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    

    
    
    
    

    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown">下载</a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                
                <a href="/emp/ewp_lib_example/ewp_lib_example.zip" class="button">html</a>
                
                
                <a href="/emp/ewp_lib_example/book.pdf" class="button">pdf</a>
                
                
            </div>
        </div>
    </div>

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" ></a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_4">
                    
                        <h1 id="宏定义">宏定义</h1>
<!-- toc -->
<ul>
<li><a href="#介绍">介绍</a></li>
<li><a href="#日志">日志</a><ul>
<li><a href="#ewplog">ewp_log</a></li>
<li><a href="#ewpmsg">ewp_msg</a></li>
<li><a href="#ewperr">ewp_err</a></li>
<li><a href="#writefile">write_file</a></li>
</ul>
</li>
<li><a href="#获取值">获取值</a><ul>
<li><a href="#param">param</a></li>
<li><a href="#session">session</a></li>
<li><a href="#arg">arg</a></li>
<li><a href="#ewpxpath">ewp_xpath</a></li>
<li><a href="#ewpconf">ewp_conf</a></li>
<li><a href="#o">o</a></li>
</ul>
</li>
</ul>
<!-- toc stop -->
<h2 id="介绍">1 介绍</h2>
<p>EWP提供了很多宏供使用，本章对项目上常用宏进行使用说明。</p>
<h2 id="日志">2 日志</h2>
<p>EWP提供了各种调试时打印日志的宏定义，下面将对这些宏定义进行说明。</p>
<h3 id="ewplog">2.1 ewp_log</h3>
<p style="color:red">注意：此宏定义只有在<code>debug</code>模式下才会打印日志。</p>

<p>如果启动了<code>syslog</code>模式则会将日志使用<code>syslog</code>驱动打印出优先级为<code>debug</code>的日志。
<code>-define(ewp_log(Format, Data), syslog_drv:debug(&quot;~p:~p &quot; ++ Format, [?MODULE,?LINE]++Data)).</code></p>
<p>在没有启动<code>syslog</code>模式时会调用<code>error_logger</code>工具记录日志：
<code>-define(ewp_log(Format, Data), error_logger:info_msg(&quot;~p:~p &quot; ++ Format, [?MODULE,?LINE]++Data)).</code></p>
<p>简单例子：</p>
<pre><code>print_msg(Msg) -&gt;
    ?ewp_log(&quot;Msg is ==== ~p~n&quot;,[Msg]).
</code></pre><p>在<code>log_test.erl</code>中写一个方法<code>print_msg</code>调用<code>ewp_log</code>，运行得到结果为：</p>
<pre><code>(ebank@tracvm)2&gt; log_test:print_msg(&quot;hello world&quot;).
ok
(ebank@tracvm)3&gt;
=INFO REPORT==== 11-May-2015::10:26:27 ===
log_test:20 Msg is ==== &quot;hello world&quot;

(ebank@tracvm)3&gt;
</code></pre><p>其中<code>log_test</code>指的是<code>Module</code>，20指的是行数。</p>
<h3 id="ewpmsg">2.2 ewp_msg</h3>
<p><code>msg</code>输入日志总是显示。所以代码中尽量少用此中方式打印日志。使用方法和<code>ewp_log</code>一样。</p>
<h3 id="ewperr">2.3 ewp_err</h3>
<p><code>err</code>输入日志总是显示，一般在记录错误信息时用此方式打印日志。使用方法和<code>ewp_log</code>一样。</p>
<pre><code>print_msg(Msg) -&gt;
    ?ewp_log(&quot;Msg is ==== ~p~n&quot;,[Msg]),
    ?ewp_msg(&quot;Msg is ==== ~p~n&quot;,[Msg]),
    ?ewp_err(&quot;Msg is ==== ~p~n&quot;,[Msg])
.
</code></pre><p>运行结果：</p>
<pre><code>(ebank@tracvm)9&gt; log_test:print_msg(&quot;hello world&quot;).

=INFO REPORT==== 11-May-2015::13:47:50 ===
log_test:20 Msg is ==== &quot;hello world&quot;

=INFO REPORT==== 11-May-2015::13:47:50 ===
log_test:21 Msg is ==== &quot;hello world&quot;

=ERROR REPORT==== 11-May-2015::13:47:50 ===
log_test:22 error: Msg is ==== &quot;hello world&quot;
ok
(ebank@tracvm)10&gt;
</code></pre><h3 id="writefile">2.4 write_file</h3>
<p>EWP提供此宏定义用于控制在<code>debug</code>模式下的写文件。</p>
<p>简单源码为：</p>
<pre><code>-ifdef(ewp_debug_flag).
-define(write_file(File, Content), file:write_file(File, Content)).
-else.
-define(write_file(File, Content), undefined).
-endif.
</code></pre><p>在开发时调用<code>?write_file</code>宏定义写文件进行调试，在生产环境上不会因为写文件消耗性能。</p>
<h2 id="获取值">3 获取值</h2>
<p>EWP提供一些宏定义用于从数据字典中获取值。</p>
<h3 id="param">3.1 param</h3>
<p>从<code>yaws</code>请求中获得参数值。</p>
<p>此宏定义有两种：<br><code>?param(Key)</code>:如果取不到值则返回<code>undefined</code>。<br><code>?param(Key, Default)</code>:如果取不到值则返回<code>Default</code>默认值。  </p>
<p>此宏定义作用,在此宏定义定义之前：</p>
<pre><code>P =  ewp_params:from_yaws_arg(A),
Token = ewp_params:get(&quot;token&quot;, P),
</code></pre><p>定义之后：</p>
<pre><code>Token = ?param(&quot;token&quot;)
</code></pre><p style="color:red">注意：从params中获取参数值必须保证先前代码中已经保存了params。</p>

<h3 id="session">3.2 session</h3>
<p>从<code>session</code>中获得参数值。</p>
<p>此宏定义有两种：  </p>
<p><code>?session(Key)</code>:如果取不到值则返回<code>undefined</code>。<br><code>?session(Key, Default)</code>:如果取不到值则返回<code>Default</code>默认值。</p>
<p>此宏定义作用,在此宏定义定义之前：</p>
<pre><code>{_SessionID, Session} = session_service:read(Arg),
UserInfo = proplists:get_value(?EBANK_USER_INFO, Session),
</code></pre><p>定义之后：</p>
<pre><code>UserInfo=?session(?EBANK_USER_INFO)
</code></pre><h3 id="arg">3.3 arg</h3>
<p>从<code>yaws_arg</code> 记录中获取参数值。</p>
<p>此宏定义有两种：  </p>
<p><code>?arg(Key)</code>:如果取不到值则返回<code>undefined</code>。<br><code>arg(Key, Default)</code>:如果取不到值则返回<code>Default</code>默认值。</p>
<p>此宏定义作用,在此宏定义定义之前：</p>
<pre><code>Docroot = Arg#arg.docroot
Headers = Arg#arg.headers,
</code></pre><p>定义之后：</p>
<pre><code>Docroot = ?arg(&quot;docroot&quot;),
Header = ?arg(&quot;headers&quot;),
</code></pre><h3 id="ewpxpath">3.4 ewp_xpath</h3>
<p>从xml term获取值。</p>
<p><code>ewp_xpath(Path, Term)</code><br>Path为xpath路径。<br>Term为xml转换的erlang term数据。</p>
<pre><code>term_test() -&gt;
    Xml = &quot;&lt;?xml version=&#39;1.0&#39; encoding=&#39;utf-8&#39;?&gt;
    &lt;ap&gt;
        &lt;gP a=\&quot;1\&quot;&gt;
            &lt;cPid&gt;1633505919140878&lt;/cPid&gt;
            &lt;activateFlag&gt;0&lt;/activateFlag&gt;
        &lt;/gP&gt;
        &lt;gP&gt;
            &lt;cPid&gt;1633505453735878&lt;/cPid&gt;
            &lt;activateFlag&gt;1&lt;/activateFlag&gt;
        &lt;/gP&gt;
        &lt;ReqId&gt;02990001&lt;/ReqId&gt;
        &lt;gP&gt;gppppp&lt;/gP&gt;
        &lt;TransCode&gt;mb60&lt;/TransCode&gt;
        &lt;MsgType&gt;02&lt;/MsgType&gt;
        &lt;RespTime&gt;083949&lt;/RespTime&gt;
        &lt;RespDate&gt;20100524&lt;/RespDate&gt;
        &lt;RespSeqNo&gt;8305240400EE&lt;/RespSeqNo&gt;
        &lt;RespCode&gt;0000&lt;/RespCode&gt;
    &lt;/ap&gt;&quot;,
    XmlTerm = xml_eng:xml_to_term(Xml),
    Xpath_1 = &quot;/ap&quot;,
    Xpath_2 = &quot;/ap/gP[1]/@a&quot;,
    Xpath_3 = &quot;/ap/gP[-1]&quot;,
    Xpath_4 = &quot;/ap/gP[2]&quot;,
    Xpath_5 = &quot;/ap/gP[2]/activateFlag/text()&quot;,
    Xpath_6 = &quot;/ap/ReqId&quot;,
    ?ewp_log(&quot;Xpath_1 get the value is = ~p~n&quot;,[?ewp_xpath(Xpath_1,XmlTerm)]),
    ?ewp_log(&quot;Xpath_2 get the value is = ~p~n&quot;,[?ewp_xpath(Xpath_2,XmlTerm)]),
    ?ewp_log(&quot;Xpath_3 get the value is = ~p~n&quot;,[?ewp_xpath(Xpath_3,XmlTerm)]),
    ?ewp_log(&quot;Xpath_4 get the value is = ~p~n&quot;,[?ewp_xpath(Xpath_4,XmlTerm)]),
    ?ewp_log(&quot;Xpath_5 get the value is = ~p~n&quot;,[?ewp_xpath(Xpath_5,XmlTerm)]),
    ?ewp_log(&quot;Xpath_6 get the value is = ~p~n&quot;,[?ewp_xpath(Xpath_6,XmlTerm)])
.
</code></pre><p>运行结果：</p>
<pre><code>(ebank@tracvm)17&gt; log_test:term_test().
ok
(ebank@tracvm)18&gt;
=INFO REPORT==== 11-May-2015::14:37:48 ===
log_test:53 Xpath_1 get the value is = [{ap,
                                         [{gP,
                                           [{attrs,[{a,&quot;1&quot;}]},
                                            {cPid,&quot;1633505919140878&quot;},
                                            {activateFlag,&quot;0&quot;}]},
                                          {gP,
                                           [{cPid,&quot;1633505453735878&quot;},
                                            {activateFlag,&quot;1&quot;}]},
                                          {&#39;ReqId&#39;,&quot;02990001&quot;},
                                          {gP,&quot;gppppp&quot;},
                                          {&#39;TransCode&#39;,&quot;mb60&quot;},
                                          {&#39;MsgType&#39;,&quot;02&quot;},
                                          {&#39;RespTime&#39;,&quot;083949&quot;},
                                          {&#39;RespDate&#39;,&quot;20100524&quot;},
                                          {&#39;RespSeqNo&#39;,&quot;8305240400EE&quot;},
                                          {&#39;RespCode&#39;,&quot;0000&quot;}]}]

=INFO REPORT==== 11-May-2015::14:37:48 ===
log_test:54 Xpath_2 get the value is = [&quot;1&quot;]

=INFO REPORT==== 11-May-2015::14:37:48 ===
log_test:55 Xpath_3 get the value is = [&quot;gppppp&quot;]

=INFO REPORT==== 11-May-2015::14:37:48 ===
log_test:56 Xpath_4 get the value is = [{gP,
                                         [{cPid,&quot;1633505453735878&quot;},
                                          {activateFlag,&quot;1&quot;}]}]

=INFO REPORT==== 11-May-2015::14:37:48 ===
log_test:57 Xpath_5 get the value is = [&quot;1&quot;]

=INFO REPORT==== 11-May-2015::14:37:48 ===
log_test:58 Xpath_6 get the value is = [&quot;02990001&quot;]
</code></pre><p>xpath语法请参照W3SCHOOL中xpath相关章节。</p>
<h3 id="ewpconf">3.5 ewp_conf</h3>
<p>从ewp conf 文件中获取参数值。</p>
<p>此宏定义有两种：<br><code>ewp_conf(Key)</code>:如果取不到值则返回<code>undefined</code>。<br><code>ewp_conf(Key,Default)</code>:如果取不到值则返回<code>Default</code>默认值。  </p>
<p>使用方法：<br><code>Environment = ?ewp_conf(&quot;environment&quot;,&quot;development&quot;),</code></p>
<h3 id="o">3.6 o</h3>
<p>EWP提供了o方法用于获取参数值。</p>
<p><code>o/2</code>:根据指定键获取指定数据结构中对应的值。数据结构可为EWP Channel Collection和Proplist。<br><code>ot/2</code>:根据指定键获取指定数据结构中对应的值，无法获取时会抛出错误。<br><code>o/3</code>:根据指定键获取指定数据结构中对应的值，无法获取时返回指定的默认值。  </p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../xml_eng/xml_eng.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: xml_eng"><i class="fa fa-angle-left"></i></a>
        
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
