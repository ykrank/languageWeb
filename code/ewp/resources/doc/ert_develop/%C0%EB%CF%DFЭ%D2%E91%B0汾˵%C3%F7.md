# 离线协议1版本说明

## 版本升级说明

在旧版离线协议的设计中，离线下载的流程完全由产品客户端代码控制，不方便脚本操作及扩展；同时每次离线更新请求时，与服务器间交互的数据量较大，不符合移动应用的开发原则。因此，基于提高下载流程可操作性，减少数据传输量的原则，产品在5.2版本中新设计了一版离线协议，并将新协议命名为离线协议1版本，将旧协议命名为离线协议0版本。

离线协议1版本,与0版本的区别主要有:

1. 在服务器端增加resource_hash接口，并与信道握手接口合并。目的在于减少离线更新请求时的数据交互；
2. 修改resource_update接口参数及返回数据格式，包括重定义离线描述文件的结构和字段名，减少数据量；
3. 增加tcp下载方式，提高下载速度；
4. 增加、调整部分lua接口，将离线下载的流程控制由客户端转到页面脚本中，增加了流程的可扩展性；
5. 增加确保更新机制，程序运行时用到的离线资源会被即时优先下载，不必再等待所有资源下载完毕，提高了用户体验。

## 服务器接口说明

### 资源更新检查接口

**接口名称：**ota/resource_hash

**功能说明：**该接口用来简易的检测是否有离线资源需要更新。服务器会为当前服务器上的必选资源和可选资源分别计算一个hash值，作为比对离线资源是否相同的标示。客户端在预置离线资源中或者每次离线更新结束后（针对必选资源，仅限于全部离线文件更新成功的情况），将此hash值永久保存到本地。在下次离线更新请求时，将本地保存的hash值上传服务器。服务器根据接收到的hash值与服务器上最新的资源hash值作对比，以此来判断客户端是否需要更新离线资源。而客户端则可以根据服务器接口返回的内容，来决定后续的流程操作。这种交互方式极大地减少了服务器上没有需要更新的离线资源时，客户端与服务器间的数据交互量，降低了流量消耗。

**接口返回：**

- 返回0，说明没有资源需要更新；
- 返回1，说明客户端必选资源描述需要更新；
- 返回2，说明客户端保存的可选资源描述需要更新；
- 返回3，说明客户端的必选资源和可选资源描述都需要更新。

**涉及到的lua接口：**

- []()



3.2 资源描述更新接口

接口名称：ota/resource_update
接口参数：desc, platform, resolution, version, hash_res.
接口返回：资源描述更新详情，格式如<服务器返回描述格式>
接口说明：

desc为客户端描述文件，格式为<客户端上传描述格式>
platform为客户端平台，如android、iphone。
resolution为客户端分辨率，如640960、320480
version为离线协议版本，初始版本为0，现（EMP5.2及以上）版本为1。默认为0
hash_res为resource_hash接口的返回值.如果客户端没有本地资源上次3.
接口使用说明:

根据ota/resource_hash接口返回的内容,决定上传的内容.
返回1,2,3时,将client.desc中的内容整理成<客户端上传描述格式>的形式.通过ota/resource_update接口上传服务器
服务器返回<服务器返回描述格式>的格式报文.根据返回内容开始资源下载.